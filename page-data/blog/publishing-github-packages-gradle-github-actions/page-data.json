{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/publishing-github-packages-gradle-github-actions","result":{"data":{"markdownRemark":{"html":"<p>In November 2019 GitHub released <a href=\"https://github.com/features/packages\">GitHub Packages</a> and <a href=\"https://github.com/features/actions\">GitHub Actions</a> to the general public. Packages allows library owners to publish their code directly to GitHub. The aim is to be another package hosting repository like <a href=\"https://www.npmjs.com/\">npmjs.com</a> or <a href=\"https://mvnrepository.com/repos/central\">Maven Central</a>, but now the packages and code can live side-by-side. GitHub Packages supports multiple package types, including Docker, RubyGems, NPM, Maven, and NuGet to name a few.</p>\n<p>GitHub Actions allows repository owners to automate their workflow with different steps that can be triggered on any repository event. This can include common things like pull request checks and publishing releases, but can it can also run on other events like <a href=\"https://github.com/actions/first-interaction\">messaging first time contributors</a>.</p>\n<p>Together both of these features are free for open source projects and they work well together to have all of the tasks around library management in a single location. As I was creating a new open source library in <a href=\"https://kotlinlang.org/\">Kotlin</a> and <a href=\"https://gradle.org/\">Gradle</a>, I thought I would try to use both Actions and Packages and document my experience along the way.</p>\n<p>If you just want a quick example, you can view all the code and GitHub files in my library, <a href=\"https://github.com/smyrick/kotlin-extensions\">kotlin-extensions</a>.</p>\n<h2>Getting Setup</h2>\n<p>The first step is to make sure our library can build locally and the output is a valid jar file. While we can use Gradle in GitHub Actions with some community created steps, I like to use the <a href=\"https://docs.gradle.org/current/userguide/gradle_wrapper.html\">Gradle Wrapper</a>. This ensures that all contributors to a project are using the same version of Gradle and we can just use the wrapper in the actions. This will also help us avoid the common <em>\"it works on my machine\"</em> problem.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./gradlew build</code></pre></div>\n<h2>Setting up GradleÂ publish</h2>\n<p>Now that we have a successful build, we want to configure Gradle so when we run the publish command it connects to GitHub Packages. I am using the <a href=\"https://docs.gradle.org/current/userguide/kotlin_dsl.html\">Gradle Kotlin DSL</a> but for more details see the <a href=\"https://docs.github.com/en/free-pro-team/packages/guides/configuring-gradle-for-use-with-github-packages\">official GitHub Packages documentation</a> on setting up Gradle.</p>\n<p>First we need to include the <code class=\"language-text\">maven-publish</code> plugin as a dependency in <code class=\"language-text\">build.gradle.kts</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// build.gradle.kts</span>\nplugins <span class=\"token punctuation\">{</span>\n    `maven<span class=\"token operator\">-</span>publish`\n    <span class=\"token comment\">// Other library plugins...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next we need to configure the publishing task by replacing <code class=\"language-text\">my-username</code> and <code class=\"language-text\">my-library</code> with the proper values. <code class=\"language-text\">GITHUB_ACTOR</code> and <code class=\"language-text\">GITHUB_TOKEN</code> are going to come from GitHub Actions so don't worry about those for now.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// build.gradle.kts continued...</span>\npublishing <span class=\"token punctuation\">{</span>\n    publications <span class=\"token punctuation\">{</span>\n        create<span class=\"token operator\">&lt;</span>MavenPublication<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"default\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">from</span><span class=\"token punctuation\">(</span>components<span class=\"token punctuation\">[</span><span class=\"token string\">\"java\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">// Include any other artifacts here, like javadocs</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    repositories <span class=\"token punctuation\">{</span>\n        maven <span class=\"token punctuation\">{</span>\n            name <span class=\"token operator\">=</span> <span class=\"token string\">\"GitHubPackages\"</span>\n            url <span class=\"token operator\">=</span> <span class=\"token function\">uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://maven.pkg.github.com/{my-username}/{my-library}\"</span><span class=\"token punctuation\">)</span>\n            credentials <span class=\"token punctuation\">{</span>\n                username <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GITHUB_ACTOR\"</span><span class=\"token punctuation\">)</span>\n                password <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GITHUB_TOKEN\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The last step we need to include is to set the library <code class=\"language-text\">group</code> and <code class=\"language-text\">version</code> in <code class=\"language-text\">gradle.properties</code>. This will allow us to change the version dynamically when we publish without having to update our main build file every release.</p>\n<div class=\"gatsby-highlight\" data-language=\"properties\"><pre class=\"language-properties\"><code class=\"language-properties\"><span class=\"token comment\"># gradle.properties</span>\n<span class=\"token attr-name\">group</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">dev.smyrick</span>\n<span class=\"token attr-name\">version</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">0.0.1-SNAPSHOT</span></code></pre></div>\n<h2>Creating GitHub Actions</h2>\n<p>Now that we have Gradle configured the next step is to execute the publish task in GitHub Actions. Create a new workflow file in <code class=\"language-text\">.github/workflows</code>. A current version of the workflow can be found in the <a href=\"https://github.com/smyrick/kotlin-extensions/blob/master/.github/workflows/publish-release.yml\">kotlin-extensions repo</a>.</p>\n<p>This workflow is publishing a new package when there is a new release in GitHub. This means that there will be tag created with the release version when this workflow is triggered.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># publish-release.yml</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish release\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">types</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>published<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Next we need to setup the steps to run on this trigger. We will checkout the code at the tagged version; set up our JVM with a specified version; and finally run the following command, passing in the new version.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./gradlew -Pversion<span class=\"token operator\">=</span><span class=\"token variable\">${version}</span> publish</code></pre></div>\n<p>The version name comes from the git tag value. Since git tags are published with the full name format of <code class=\"language-text\">refs/tags/xxxx</code> we can run a simple cut to extract the tag name and use that as our version. The <code class=\"language-text\">GITHUB_ACTOR</code> is set for all GitHub Actions as an environment variable. The <code class=\"language-text\">GITHUB_TOKEN</code> is set for all actions but it is in the secrets, so we must copy it to an environment variable that we are using in our Gradle configuration. GitHub is smart enough though to not expose this value in the logs even if environment value is logged. See the the Actions documentation for a list of <a href=\"https://docs.github.com/en/free-pro-team/actions/reference/environment-variables\">all environment variables</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># publish-release.yml continued...</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">publish-release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout latest code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up JDK 11\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>java@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">java-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">11</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish artifact\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\"># The GITHUB_REF tag comes in the format 'refs/tags/xxx'.</span>\n        <span class=\"token comment\"># If we split on '/' and take the 3rd value,</span>\n        <span class=\"token comment\"># we can get the release name.</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          NEW_VERSION=$(echo \"${GITHUB_REF}\" | cut -d \"/\" -f3)\n          echo \"New version: ${NEW_VERSION}\"\n          echo \"Github username: ${GITHUB_ACTOR}\"\n          ./gradlew -Pversion=${NEW_VERSION} publish</span></code></pre></div>\n<h2>Monitoring Packages</h2>\n<p>After we have Gradle setup and the GitHub Actions checked in, we can release a new version of our library. The release notes from the tag will be copied over as the package description which can be helpful to mention any changes that occured for the new version.</p>\n<p>As an example, <a href=\"https://github.com/smyrick/kotlin-extensions/releases/tag/0.0.19\">this tag release</a> resulted in <a href=\"https://github.com/smyrick/kotlin-extensions/packages/55467?version=0.0.19\">this package</a> being published. From the packages view we can also track the number of downloads and other packages using the specific version. This can be helpful for the new features coming to GitHub <a href=\"https://help.github.com/en/github/managing-security-vulnerabilities/managing-security-vulnerabilities-in-your-project\">around security</a>, which will allow us to alert all dependents of any vulnerabilities in a specific version and ask them to update.</p>\n<hr>\n<p>That wraps up this short post. I hope you will find the information helpful so you donât have to spend an afternoon reading through the GitHub documentation as I did (which is still very good).</p>\n<p>Feel free to share your own experience with GitHub Actions and Packages with me on <a href=\"https://twitter.com/shanemyrick\">Twitter</a> and follow me for future articles! ð</p>\n<hr>\n<p><em>This was <a href=\"https://medium.com/@shanemyrick/publishing-to-github-packages-with-gradle-and-github-actions-4ad842634c4e\">orginally posted to Medium</a> and moved to my personal blog at a later date.</em></p>","excerpt":"In November 2019 GitHub released GitHub Packages and GitHub Actions to the general public. Packages allows library owners to publish their code directly toâ¦","frontmatter":{"date":"04 December, 2019","path":"/blog/publishing-github-packages-gradle-github-actions","title":"Publishing to GitHub Packages with Gradle and GitHub Actions","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQoz1WS20rDQBCG82iCpycQFF9BLAiiF94peqV4L+gb+CQVRPB0IZYmRRNL0ybNcXfzOzObTduFYXOY/eaf+dfTBtCmgdINaoV253d0u6wG8r+qbV5ZGXrW9F/DGIOm4e8GHgMczAEdjPJk/5kYhLFBUTWg8xT8zwLyUtF3TQU0PWsLdEoW4IXa68cEO1djbJ9FOL0fkypjBZMicJD0mpKzkgrWgLeszO0VATk3ihX2Lkc4uRti92KAzeMvDH8LARqBUT4pyUgZwwoax0rLTi3Pidc0rbF+9I798zf0bt+wdvCMj0FCLWtpk2fIsFxgNrxlmG3bmtS0Cs4fvrFx+IStXh+9m3dSb3N5Xq5NFznN2LPzWnJVmQ42jWOE4S9eP330X77hj36QpjNxVWwXZ0khOc4wLuDJtdFOoXWuJBm8BwQY+gGCIMBfFML3fYRRJAXZ5UmaI8nKDiYKZ1mNeaEkgRNdMgO5GI0JJbdpWlPbxc5GcUrAugOKwnCSIE7m0oK9CfYUt5WXNpmDi/JhUcJGUJWs0BbWAucF30Olupu+ClOS7AYublamHT66Qk4Zwzj+AfWaS/psygcnAAAAAElFTkSuQmCC","aspectRatio":1.7857142857142858,"src":"/static/5153121965dab5532eeb399f452f2e5e/73c85/github-actions.png","srcSet":"/static/5153121965dab5532eeb399f452f2e5e/69585/github-actions.png 200w,\n/static/5153121965dab5532eeb399f452f2e5e/497c6/github-actions.png 400w,\n/static/5153121965dab5532eeb399f452f2e5e/73c85/github-actions.png 700w","sizes":"(max-width: 700px) 100vw, 700px"}}}},"fields":{"readingTime":{"text":"5 min read"}}}},"pageContext":{}},"staticQueryHashes":["3649515864","63159454"]}